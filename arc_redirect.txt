# arc_redirect v0.1-dev
# Love redirects, hate 404s
# Andy Carter
# http://redhotchilliproject.com/

# ......................................................................
# This is a plugin for Textpattern - http://textpattern.com/
# To install: textpattern > admin > plugins
# Paste the following text into the 'Install plugin' box:
# ......................................................................

YToxMTp7czo0OiJuYW1lIjtzOjEyOiJhcmNfcmVkaXJlY3QiO3M6NzoidmVyc2lvbiI7czo3
OiIwLjEtZGV2IjtzOjY6ImF1dGhvciI7czoxMToiQW5keSBDYXJ0ZXIiO3M6MTA6ImF1dGhv
cl91cmkiO3M6MzE6Imh0dHA6Ly9yZWRob3RjaGlsbGlwcm9qZWN0LmNvbS8iO3M6MTE6ImRl
c2NyaXB0aW9uIjtzOjI1OiJMb3ZlIHJlZGlyZWN0cywgaGF0ZSA0MDRzIjtzOjU6Im9yZGVy
IjtzOjE6IjUiO3M6NDoidHlwZSI7czoxOiIxIjtzOjU6ImZsYWdzIjtzOjE6IjIiO3M6NDoi
aGVscCI7czowOiIiO3M6NDoiY29kZSI7czo0NjQwOiJyZWdpc3Rlcl9jYWxsYmFjaygnYXJj
X3JlZGlyZWN0X2luc3RhbGwnLCdwbHVnaW5fbGlmZWN5Y2xlLmFyY19yZWRpcmVjdCcsICdp
bnN0YWxsZWQnKTsKcmVnaXN0ZXJfY2FsbGJhY2soJ2FyY19yZWRpcmVjdF91bmluc3RhbGwn
LCdwbHVnaW5fbGlmZWN5Y2xlLmFyY19yZWRpcmVjdCcsICdkZWxldGVkJyk7CnJlZ2lzdGVy
X2NhbGxiYWNrKCdhcmNfcmVkaXJlY3QnLCAndHhwX2RpZScsIDQwNCk7CmFkZF9wcml2cygn
YXJjX3JlZGlyZWN0JywgJzEsMiwzLDQnKTsKcmVnaXN0ZXJfdGFiKCdleHRlbnNpb25zJywg
J2FyY19yZWRpcmVjdCcsICdhcmNfcmVkaXJlY3QnKTsKcmVnaXN0ZXJfY2FsbGJhY2soJ2Fy
Y19yZWRpcmVjdF90YWInLCAnYXJjX3JlZGlyZWN0Jyk7CgovKgogKiBDaGVjayBmb3IgcmVk
aXJlY3RlZCBVUkxzIGFuZCBmb3J3YXJkIHdpdGggYSAzMDEgd2hlcmUgbmVjZXNzYXJ5Lgog
Ki8KZnVuY3Rpb24gYXJjX3JlZGlyZWN0KCRldmVudCwgJHN0ZXApIHsKICAkdXJsID0gUFJP
VE9DT0wuJF9TRVJWRVJbJ1NFUlZFUl9OQU1FJ10uJF9TRVJWRVJbJ1JFUVVFU1RfVVJJJ107
CgogICRzcWwgPSAiU0VMRUNUIHJlZGlyZWN0VXJsIEZST00gIi5QRlguImFyY19yZWRpcmVj
dCBXSEVSRSBvcmlnaW5hbFVybCA9ICciLiR1cmwuIic7IjsKICAkcnMgPSBzYWZlX3F1ZXJ5
KCRzcWwpOyAkcmVkaXJlY3QgPSBuZXh0Um93KCRycyk7CgoJICBpZiAoJHJlZGlyZWN0Wydy
ZWRpcmVjdFVybCddKSB7CgkJICBvYl9lbmRfY2xlYW4oKTsKCgkJICBoZWFkZXIoIlN0YXR1
czogMzAxIik7CgkJICBoZWFkZXIoIkhUVFAvMS4wIDMwMSBNb3ZlZCBQZXJtYW5lbnRseSIp
OwoJCSAgaGVhZGVyKCJMb2NhdGlvbjogIi4kcmVkaXJlY3RbJ3JlZGlyZWN0VXJsJ10sIFRS
VUUsIDMwMSk7CgoJCSAgLy8gSW4gY2FzZSB0aGUgaGVhZGVyKCkgbWV0aG9kIGZhaWxzLCBm
YWxsIGJhY2sgb24gYSBjbGFzc2ljIHJlZGlyZWN0CgkJICBlY2hvICc8aHRtbD48aGVhZD48
TUVUQSBIVFRQLUVRVUlWPSJSZWZyZXNoIiBDT05URU5UPSIwO1VSTD0nCgkJICAgIC4kcGVy
bWxpbmsuJyI+PC9oZWFkPjxib2R5PjwvYm9keT48L2h0bWw+JzsKCQkgIGRpZSgpOwoJICB9
Cgp9CgpmdW5jdGlvbiBhcmNfcmVkaXJlY3RfdGFiKCRldmVudCwgJHN0ZXApIHsKICBzd2l0
Y2ggKCRzdGVwKSB7CiAgICBjYXNlICdhZGQnOiBhcmNfcmVkaXJlY3RfYWRkKCk7IGJyZWFr
OwogICAgY2FzZSAnc2F2ZSc6IGFyY19yZWRpcmVjdF9zYXZlKCk7IGJyZWFrOwogICAgY2Fz
ZSAnZWRpdCc6IGFyY19yZWRpcmVjdF9lZGl0KCk7IGJyZWFrOwogICAgZGVmYXVsdDogYXJj
X3JlZGlyZWN0X2xpc3QoKTsKICB9Cn0KCmZ1bmN0aW9uIGFyY19yZWRpcmVjdF9saXN0KCRt
ZXNzYWdlID0gJycpIHsKCiAgcGFnZXRvcCgnYXJjX3JlZGlyZWN0JywkbWVzc2FnZSk7Cgog
ICRzcWwgPSAiU0VMRUNUICogRlJPTSAiLlBGWC4iYXJjX3JlZGlyZWN0OyI7CiAgJHJzID0g
c2FmZV9xdWVyeSgkc3FsKTsKCiAgJGh0bWwgPSBzdGFydFRhYmxlKCdlZGl0Jyk7CgogICRo
dG1sIC49IHRyKAogICAgaENlbGwgKCdJRCMnKQogICAgLmhDZWxsICgpCiAgICAuaENlbGwg
KCdPcmlnaW5hbCBVUkwnKQogICAgLmhDZWxsICgnUmVkaXJlY3QgVVJMJykKICApOwoKICB3
aGlsZSAoJHJlZGlyZWN0ID0gbmV4dFJvdygkcnMpKSB7CiAgICAkZWRpdExpbmsgPSBocmVm
KGdUeHQoJ2VkaXQnKSwKICAgICAgJz9ldmVudD1hcmNfcmVkaXJlY3QmYW1wO3N0ZXA9ZWRp
dCZhbXA7aWQ9Jy4kcmVkaXJlY3RbJ2FyY19yZWRpcmVjdElEJ10pOwogICAgJGh0bWwgLj0g
dHIoCiAgICAgIHRkKCRyZWRpcmVjdFsnYXJjX3JlZGlyZWN0SUQnXSwgMjAsICdpZCcpCiAg
ICAgIC50ZCgiPHVsPjxsaSBjbGFzcz0nYWN0aW9uLWVkaXQnPiRlZGl0TGluazwvbGk+PC91
bD4iLCAzNSwgJ2FjdGlvbnMnKQogICAgICAudGQoJHJlZGlyZWN0WydvcmlnaW5hbFVybCdd
LCAxNzUpCiAgICAgIC50ZCgkcmVkaXJlY3RbJ3JlZGlyZWN0VXJsJ10sIDE3NSkKICAgICk7
CiAgfQoKICAkaHRtbCAuPSBlbmRUYWJsZSgpOwoKICBlY2hvICRodG1sOwoKfQoKZnVuY3Rp
b24gYXJjX3JlZGlyZWN0X2VkaXQoJG1lc3NhZ2U9JycpIHsKICBwYWdldG9wKCdhcmNfcmVk
aXJlY3QnLCRtZXNzYWdlKTsKCiAgJG9yaWdpbmFsVXJsID0gZ3BzKCdvcmlnaW5hbFVybCcp
OwogICRyZWRpcmVjdFVybCA9IGdwcygncmVkaXJlY3RVcmwnKTsKCiAgaWYgKCRpZD1ncHMo
J2lkJykpIHsKICAgICRycyA9IHNhZmVfcm93KCdvcmlnaW5hbFVybCxyZWRpcmVjdFVybCcs
ICdhcmNfcmVkaXJlY3QnLCAiYXJjX3JlZGlyZWN0SUQgPSAkaWQiKTsKICAgIGV4dHJhY3Qo
JHJzKTsKICB9CgogIGVjaG8gc3RhcnRUYWJsZSgnZWRpdCcpLnRyKHRkKAoKICAgIGZvcm0o
CiAgICAgIHRhZyh0YWcoJ09yaWdpbmFsIFVSTCcsJ2xhYmVsJywgJyBmb3I9Im9yaWdpbmFs
VXJsIicpCiAgICAgIC5mSW5wdXQoJ3RleHQnLCdvcmlnaW5hbFVybCcsJG9yaWdpbmFsVXJs
LCdlZGl0JywnJywnJywnJywnJywnb3JpZ2luYWxVcmwnKSwncCcpCiAgICAgIC50YWcodGFn
KCdSZWRpcmVjdCBVUkwnLCdsYWJlbCcsICcgZm9yPSJyZWRpcmVjdFVybCInKQogICAgICAu
ZklucHV0KCd0ZXh0JywncmVkaXJlY3RVcmwnLCRyZWRpcmVjdFVybCwnZWRpdCcsJycsJycs
JycsJycsJ3JlZGlyZWN0VXJsJyksJ3AnKQogICAgICAuZUlucHV0KCdhcmNfcmVkaXJlY3Qn
KQogICAgICAuKCgkaWQpPwogICAgICAgIHNJbnB1dCgnc2F2ZScpLmhJbnB1dCgnaWQnLCRp
ZCkuZklucHV0KCdzdWJtaXQnLCdzYXZlJyxnVHh0KCdTYXZlJyksJ3B1Ymxpc2gnKQogICAg
ICAgIDpzSW5wdXQoJ2FkZCcpLmZJbnB1dCgnc3VibWl0JywnYWRkJyxnVHh0KCdBZGQnKSwn
cHVibGlzaCcpCiAgICAgICkuYnIKICAgICkKICApKS5lbmRUYWJsZSgpOwoKfQoKZnVuY3Rp
b24gYXJjX3JlZGlyZWN0X2FkZCgpIHsKICAkb3JpZ2luYWxVcmwgPSBncHMoJ29yaWdpbmFs
VXJsJyk7CiAgJHJlZGlyZWN0VXJsID0gZ3BzKCdyZWRpcmVjdFVybCcpOwoKICBpZiAoJG9y
aWdpbmFsVXJsID09PSAnJyB8fCAkcmVkaXJlY3RVcmwgPT09ICcnKSB7CiAgICBhcmNfcmVk
aXJlY3RfZWRpdCgnVW5hYmxlIHRvIGFkZCBuZXcgcmVkaXJlY3QnKTsKICAgIHJldHVybjsK
ICB9CgogICRxID0gc2FmZV9pbnNlcnQoImFyY19yZWRpcmVjdCIsCiAgICAib3JpZ2luYWxV
cmwgPSAnIi50cmltKCRvcmlnaW5hbFVybCkuIicsIHJlZGlyZWN0VXJsID0gJyIudHJpbSgk
cmVkaXJlY3RVcmwpLiInIgogICk7CgogICRHTE9CQUxTWydJRCddID0gbXlzcWxfaW5zZXJ0
X2lkKCk7CgogIGlmICgkcSkgewogICAgJG1lc3NhZ2UgPSBnVHh0KCdSZWRpcmVjdCBhZGRl
ZCcpOwogICAgYXJjX3JlZGlyZWN0X2xpc3QoJG1lc3NhZ2UpOwogIH0KfQoKZnVuY3Rpb24g
YXJjX3JlZGlyZWN0X3NhdmUoKSB7CgogIGlmICghJGlkPWdwcygnaWQnKSkgewogICAgYXJj
X3JlZGlyZWN0X2xpc3QoJ1VuYWJsZSB0byBzYXZlIHJlZGlyZWN0Jyk7CiAgICByZXR1cm47
CiAgfQoKICAkb3JpZ2luYWxVcmwgPSBncHMoJ29yaWdpbmFsVXJsJyk7CiAgJHJlZGlyZWN0
VXJsID0gZ3BzKCdyZWRpcmVjdFVybCcpOwoKICBpZiAoJG9yaWdpbmFsVXJsID09ICcnIHx8
ICRyZWRpcmVjdFVybCA9PSAnJykgewogICAgYXJjX3JlZGlyZWN0X2VkaXQoJ1VuYWJsZSB0
byBzYXZlIHJlZGlyZWN0Jyk7CiAgICByZXR1cm47CiAgfQoKICAkcnMgPSBzYWZlX3VwZGF0
ZSgiYXJjX3JlZGlyZWN0IiwKICAgICJvcmlnaW5hbFVybCAgICA9ICciLnRyaW0oJG9yaWdp
bmFsVXJsKS4iJywgIHJlZGlyZWN0VXJsID0gJyIudHJpbSgkcmVkaXJlY3RVcmwpLiInIiwK
ICAgICJhcmNfcmVkaXJlY3RJRCA9ICRpZCIKICApOwoKICBpZiAoJHJzKSB7CiAgICAkbWVz
c2FnZSA9IGdUeHQoJ1JlZGlyZWN0IHVwZGF0ZWQnKTsKICAgIGFyY19yZWRpcmVjdF9saXN0
KCRtZXNzYWdlKTsKICB9Cn0KCi8vIEluc3RhbGxhdGlvbiBmdW5jdGlvbiAtIGJ1aWxkcyBN
eVNRTCB0YWJsZQpmdW5jdGlvbiBhcmNfcmVkaXJlY3RfaW5zdGFsbCgpCnsKCiAgLy8gRm9y
IGZpcnN0IGluc3RhbGwsIGNyZWF0ZSB0YWJsZSBmb3IgdHdlZXRzCiAgJHNxbCA9ICJDUkVB
VEUgVEFCTEUgSUYgTk9UIEVYSVNUUyAiLlBGWC4iYXJjX3JlZGlyZWN0ICI7CiAgJHNxbC49
ICIoYXJjX3JlZGlyZWN0SUQgSU5URUdFUiBBVVRPX0lOQ1JFTUVOVCBQUklNQVJZIEtFWSwK
ICAgIG9yaWdpbmFsVXJsIFZBUkNIQVIoMjQwKSwKICAgIHJlZGlyZWN0VXJsIFZBUkNIQVIo
MjQwKSk7IjsKCiAgaWYgKCFzYWZlX3F1ZXJ5KCRzcWwpKSB7CiAgICByZXR1cm4gJ0Vycm9y
IC0gdW5hYmxlIHRvIGNyZWF0ZSBhcmNfcmVkaXJlY3QgdGFibGUnOwogIH0KCn0KCi8vIFVu
aW5zdGFsbCBmdW5jdGlvbiAtIGRlbGV0ZXMgTXlTUUwgdGFibGUgYW5kIHJlbGF0ZWQgcHJl
ZmVyZW5jZXMKCmZ1bmN0aW9uIGFyY19yZWRpcmVjdF91bmluc3RhbGwoKQp7CiAgJHNxbCA9
ICJEUk9QIFRBQkxFIElGIEVYSVNUUyAiLlBGWC4iYXJjX3JlZGlyZWN0OyI7CiAgaWYgKCFz
YWZlX3F1ZXJ5KCRzcWwpKSB7CiAgICByZXR1cm4gJ0Vycm9yIC0gdW5hYmxlIHRvIGRlbGV0
ZSBhcmNfcmVkaXJlY3QgdGFibGUnOwogIH0KfSI7czozOiJtZDUiO3M6MzI6ImNiMjdkMWY2
YzVlNjY3Y2I4NzAwODgxYjU5ZGQ3MzYzIjt9
