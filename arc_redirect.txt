# arc_redirect v0.1-dev
# Love redirects, hate 404s
# Andy Carter
# http://redhotchilliproject.com/

# ......................................................................
# This is a plugin for Textpattern - http://textpattern.com/
# To install: textpattern > admin > plugins
# Paste the following text into the 'Install plugin' box:
# ......................................................................

YToxMTp7czo0OiJuYW1lIjtzOjEyOiJhcmNfcmVkaXJlY3QiO3M6NzoidmVyc2lvbiI7czo3
OiIwLjEtZGV2IjtzOjY6ImF1dGhvciI7czoxMToiQW5keSBDYXJ0ZXIiO3M6MTA6ImF1dGhv
cl91cmkiO3M6MzE6Imh0dHA6Ly9yZWRob3RjaGlsbGlwcm9qZWN0LmNvbS8iO3M6MTE6ImRl
c2NyaXB0aW9uIjtzOjI1OiJMb3ZlIHJlZGlyZWN0cywgaGF0ZSA0MDRzIjtzOjU6Im9yZGVy
IjtzOjE6IjUiO3M6NDoidHlwZSI7czoxOiIxIjtzOjU6ImZsYWdzIjtzOjE6IjIiO3M6NDoi
aGVscCI7czowOiIiO3M6NDoiY29kZSI7czo1MzkwOiJyZWdpc3Rlcl9jYWxsYmFjaygnYXJj
X3JlZGlyZWN0X2luc3RhbGwnLCdwbHVnaW5fbGlmZWN5Y2xlLmFyY19yZWRpcmVjdCcsICdp
bnN0YWxsZWQnKTsKcmVnaXN0ZXJfY2FsbGJhY2soJ2FyY19yZWRpcmVjdF91bmluc3RhbGwn
LCdwbHVnaW5fbGlmZWN5Y2xlLmFyY19yZWRpcmVjdCcsICdkZWxldGVkJyk7CnJlZ2lzdGVy
X2NhbGxiYWNrKCdhcmNfcmVkaXJlY3QnLCAndHhwX2RpZScsIDQwNCk7CmFkZF9wcml2cygn
YXJjX3JlZGlyZWN0JywgJzEsMiwzLDQnKTsKcmVnaXN0ZXJfdGFiKCdleHRlbnNpb25zJywg
J2FyY19yZWRpcmVjdCcsICdhcmNfcmVkaXJlY3QnKTsKcmVnaXN0ZXJfY2FsbGJhY2soJ2Fy
Y19yZWRpcmVjdF90YWInLCAnYXJjX3JlZGlyZWN0Jyk7CgovKgogKiBDaGVjayBmb3IgcmVk
aXJlY3RlZCBVUkxzIGFuZCBmb3J3YXJkIHdpdGggYSAzMDEgd2hlcmUgbmVjZXNzYXJ5Lgog
Ki8KZnVuY3Rpb24gYXJjX3JlZGlyZWN0KCRldmVudCwgJHN0ZXApIHsKICAkdXJsID0gUFJP
VE9DT0wuJF9TRVJWRVJbJ1NFUlZFUl9OQU1FJ10uJF9TRVJWRVJbJ1JFUVVFU1RfVVJJJ107
CgogICRzcWwgPSAiU0VMRUNUIHJlZGlyZWN0VXJsIEZST00gIi5QRlguImFyY19yZWRpcmVj
dCBXSEVSRSBvcmlnaW5hbFVybCA9ICciLiR1cmwuIic7IjsKICAkcnMgPSBzYWZlX3F1ZXJ5
KCRzcWwpOyAkcmVkaXJlY3QgPSBuZXh0Um93KCRycyk7CgoJICBpZiAoJHJlZGlyZWN0Wydy
ZWRpcmVjdFVybCddKSB7CgkJICBvYl9lbmRfY2xlYW4oKTsKCgkJICBoZWFkZXIoIlN0YXR1
czogMzAxIik7CgkJICBoZWFkZXIoIkhUVFAvMS4wIDMwMSBNb3ZlZCBQZXJtYW5lbnRseSIp
OwoJCSAgaGVhZGVyKCJMb2NhdGlvbjogIi4kcmVkaXJlY3RbJ3JlZGlyZWN0VXJsJ10sIFRS
VUUsIDMwMSk7CgoJCSAgLy8gSW4gY2FzZSB0aGUgaGVhZGVyKCkgbWV0aG9kIGZhaWxzLCBm
YWxsIGJhY2sgb24gYSBjbGFzc2ljIHJlZGlyZWN0CgkJICBlY2hvICc8aHRtbD48aGVhZD48
TUVUQSBIVFRQLUVRVUlWPSJSZWZyZXNoIiBDT05URU5UPSIwO1VSTD0nCgkJICAgIC4kcGVy
bWxpbmsuJyI+PC9oZWFkPjxib2R5PjwvYm9keT48L2h0bWw+JzsKCQkgIGRpZSgpOwoJICB9
Cgp9CgpmdW5jdGlvbiBhcmNfcmVkaXJlY3RfdGFiKCRldmVudCwgJHN0ZXApIHsKICBzd2l0
Y2ggKCRzdGVwKSB7CiAgICBjYXNlICdhZGQnOiBhcmNfcmVkaXJlY3RfYWRkKCk7IGJyZWFr
OwogICAgY2FzZSAnc2F2ZSc6IGFyY19yZWRpcmVjdF9zYXZlKCk7IGJyZWFrOwogICAgY2Fz
ZSAnZWRpdCc6IGFyY19yZWRpcmVjdF9lZGl0KCk7IGJyZWFrOwogICAgZGVmYXVsdDogYXJj
X3JlZGlyZWN0X2xpc3QoKTsKICB9Cn0KCmZ1bmN0aW9uIGFyY19yZWRpcmVjdF9saXN0KCRt
ZXNzYWdlID0gJycpIHsKCiAgcGFnZXRvcCgnYXJjX3JlZGlyZWN0JywkbWVzc2FnZSk7Cgog
ICRzcWwgPSAiU0VMRUNUICogRlJPTSAiLlBGWC4iYXJjX3JlZGlyZWN0OyI7CiAgJHJzID0g
c2FmZV9xdWVyeSgkc3FsKTsKCiAgLy8gSW5jbHVkZSBhIHF1aWNrIGFkZCBmb3JtCiAgJGh0
bWwgPSBmb3JtKAogICAgc3RhcnRUYWJsZSgnZWRpdCcpCiAgICAgIC50cigKICAgICAgICB0
ZGEodGFnKCdPcmlnaW5hbCBVUkwnLCdsYWJlbCcsICcgZm9yPSJvcmlnaW5hbFVybCInKSwn
IHN0eWxlPSJ2ZXJ0aWNhbC1hbGlnbjptaWRkbGUiJykKICAgICAgICAudGQoZklucHV0KCd0
ZXh0Jywnb3JpZ2luYWxVcmwnLCcnLCdlZGl0JywnJywnJywnJywnJywnb3JpZ2luYWxVcmwn
KSkKICAgICAgKS50cigKICAgICAgICB0ZGEodGFnKCdSZWRpcmVjdCBVUkwnLCdsYWJlbCcs
ICcgZm9yPSJyZWRpcmVjdFVybCInKSwnIHN0eWxlPSJ2ZXJ0aWNhbC1hbGlnbjptaWRkbGUi
JykKICAgICAgICAudGQoZklucHV0KCd0ZXh0JywncmVkaXJlY3RVcmwnLCcnLCdlZGl0Jywn
JywnJywnJywnJywncmVkaXJlY3RVcmwnKQogICAgICAgIC5lSW5wdXQoJ2FyY19yZWRpcmVj
dCcpCiAgICAgICAgLnNJbnB1dCgnYWRkJykuJyZuYnNwOycuZklucHV0KCdzdWJtaXQnLCdh
ZGQnLGdUeHQoJ0FkZCcpLCdwdWJsaXNoJykKICAgICAgICApCiAgICAgICkKICAgIC5lbmRU
YWJsZSgpCiAgLCAnbWFyZ2luLWJvdHRvbToyNXB4Jyk7CgogIC8vIEFkZCBhIGxpc3Qgb2Yg
ZXhpc3RpbmcgcmVkaXJlY3RzCiAgJGh0bWwgLj0gc3RhcnRUYWJsZSgnbGlzdCcpOwoKICAk
aHRtbCAuPSB0cigKICAgIGhDZWxsICgnSUQjJykKICAgIC5oQ2VsbCAoKQogICAgLmhDZWxs
ICgnT3JpZ2luYWwgVVJMJykKICAgIC5oQ2VsbCAoJ1JlZGlyZWN0IFVSTCcpCiAgKTsKCiAg
d2hpbGUgKCRyZWRpcmVjdCA9IG5leHRSb3coJHJzKSkgewogICAgJGVkaXRMaW5rID0gaHJl
ZihnVHh0KCdlZGl0JyksCiAgICAgICc/ZXZlbnQ9YXJjX3JlZGlyZWN0JmFtcDtzdGVwPWVk
aXQmYW1wO2lkPScuJHJlZGlyZWN0WydhcmNfcmVkaXJlY3RJRCddKTsKICAgICRyZWRpcmVj
dExpbmsgPSBocmVmKCdUZXN0JywkcmVkaXJlY3RbJ29yaWdpbmFsVXJsJ10pOwogICAgJGh0
bWwgLj0gdHIoCiAgICAgIHRkKCRyZWRpcmVjdFsnYXJjX3JlZGlyZWN0SUQnXSwgMjAsICdp
ZCcpCiAgICAgIC50ZCgiPHVsPjxsaSBjbGFzcz0nYWN0aW9uLWVkaXQnPiRlZGl0TGluazwv
bGk+PGxpIGNsYXNzPSdhY3Rpb24tdmlldyc+JHJlZGlyZWN0TGluazwvbGk+PC91bD4iLCAz
NSwgJ2FjdGlvbnMnKQogICAgICAudGQoJHJlZGlyZWN0WydvcmlnaW5hbFVybCddLCAxNzUp
CiAgICAgIC50ZCgkcmVkaXJlY3RbJ3JlZGlyZWN0VXJsJ10sIDE3NSkKICAgICk7CiAgfQoK
ICAkaHRtbCAuPSBlbmRUYWJsZSgpOwoKICBlY2hvICRodG1sOwoKfQoKZnVuY3Rpb24gYXJj
X3JlZGlyZWN0X2VkaXQoJG1lc3NhZ2U9JycpIHsKICBwYWdldG9wKCdhcmNfcmVkaXJlY3Qn
LCRtZXNzYWdlKTsKCiAgJG9yaWdpbmFsVXJsID0gZ3BzKCdvcmlnaW5hbFVybCcpOwogICRy
ZWRpcmVjdFVybCA9IGdwcygncmVkaXJlY3RVcmwnKTsKCiAgaWYgKCRpZD1ncHMoJ2lkJykp
IHsKICAgICRycyA9IHNhZmVfcm93KCdvcmlnaW5hbFVybCxyZWRpcmVjdFVybCcsICdhcmNf
cmVkaXJlY3QnLCAiYXJjX3JlZGlyZWN0SUQgPSAkaWQiKTsKICAgIGV4dHJhY3QoJHJzKTsK
ICB9CgogIGVjaG8gc3RhcnRUYWJsZSgnZWRpdCcpLnRyKHRkKAoKICAgIGZvcm0oCiAgICAg
IHRhZyh0YWcoJ09yaWdpbmFsIFVSTCcsJ2xhYmVsJywgJyBmb3I9Im9yaWdpbmFsVXJsIicp
CiAgICAgIC5mSW5wdXQoJ3RleHQnLCdvcmlnaW5hbFVybCcsJG9yaWdpbmFsVXJsLCdlZGl0
JywnJywnJywnJywnJywnb3JpZ2luYWxVcmwnKSwncCcpCiAgICAgIC50YWcodGFnKCdSZWRp
cmVjdCBVUkwnLCdsYWJlbCcsICcgZm9yPSJyZWRpcmVjdFVybCInKQogICAgICAuZklucHV0
KCd0ZXh0JywncmVkaXJlY3RVcmwnLCRyZWRpcmVjdFVybCwnZWRpdCcsJycsJycsJycsJycs
J3JlZGlyZWN0VXJsJyksJ3AnKQogICAgICAuZUlucHV0KCdhcmNfcmVkaXJlY3QnKQogICAg
ICAuKCgkaWQpPwogICAgICAgIHNJbnB1dCgnc2F2ZScpLmhJbnB1dCgnaWQnLCRpZCkuZklu
cHV0KCdzdWJtaXQnLCdzYXZlJyxnVHh0KCdTYXZlJyksJ3B1Ymxpc2gnKQogICAgICAgIDpz
SW5wdXQoJ2FkZCcpLmZJbnB1dCgnc3VibWl0JywnYWRkJyxnVHh0KCdBZGQnKSwncHVibGlz
aCcpCiAgICAgICkuYnIKICAgICkKICApKS5lbmRUYWJsZSgpOwoKfQoKZnVuY3Rpb24gYXJj
X3JlZGlyZWN0X2FkZCgpIHsKICAkb3JpZ2luYWxVcmwgPSBncHMoJ29yaWdpbmFsVXJsJyk7
CiAgJHJlZGlyZWN0VXJsID0gZ3BzKCdyZWRpcmVjdFVybCcpOwoKICBpZiAoJG9yaWdpbmFs
VXJsID09PSAnJyB8fCAkcmVkaXJlY3RVcmwgPT09ICcnKSB7CiAgICBhcmNfcmVkaXJlY3Rf
ZWRpdCgnVW5hYmxlIHRvIGFkZCBuZXcgcmVkaXJlY3QnKTsKICAgIHJldHVybjsKICB9Cgog
ICRxID0gc2FmZV9pbnNlcnQoImFyY19yZWRpcmVjdCIsCiAgICAib3JpZ2luYWxVcmwgPSAn
Ii50cmltKCRvcmlnaW5hbFVybCkuIicsIHJlZGlyZWN0VXJsID0gJyIudHJpbSgkcmVkaXJl
Y3RVcmwpLiInIgogICk7CgogICRHTE9CQUxTWydJRCddID0gbXlzcWxfaW5zZXJ0X2lkKCk7
CgogIGlmICgkcSkgewogICAgJG1lc3NhZ2UgPSBnVHh0KCdSZWRpcmVjdCBhZGRlZCcpOwog
ICAgYXJjX3JlZGlyZWN0X2xpc3QoJG1lc3NhZ2UpOwogIH0KfQoKZnVuY3Rpb24gYXJjX3Jl
ZGlyZWN0X3NhdmUoKSB7CgogIGlmICghJGlkPWdwcygnaWQnKSkgewogICAgYXJjX3JlZGly
ZWN0X2xpc3QoJ1VuYWJsZSB0byBzYXZlIHJlZGlyZWN0Jyk7CiAgICByZXR1cm47CiAgfQoK
ICAkb3JpZ2luYWxVcmwgPSBncHMoJ29yaWdpbmFsVXJsJyk7CiAgJHJlZGlyZWN0VXJsID0g
Z3BzKCdyZWRpcmVjdFVybCcpOwoKICBpZiAoJG9yaWdpbmFsVXJsID09ICcnIHx8ICRyZWRp
cmVjdFVybCA9PSAnJykgewogICAgYXJjX3JlZGlyZWN0X2VkaXQoJ1VuYWJsZSB0byBzYXZl
IHJlZGlyZWN0Jyk7CiAgICByZXR1cm47CiAgfQoKICAkcnMgPSBzYWZlX3VwZGF0ZSgiYXJj
X3JlZGlyZWN0IiwKICAgICJvcmlnaW5hbFVybCAgICA9ICciLnRyaW0oJG9yaWdpbmFsVXJs
KS4iJywgIHJlZGlyZWN0VXJsID0gJyIudHJpbSgkcmVkaXJlY3RVcmwpLiInIiwKICAgICJh
cmNfcmVkaXJlY3RJRCA9ICRpZCIKICApOwoKICBpZiAoJHJzKSB7CiAgICAkbWVzc2FnZSA9
IGdUeHQoJ1JlZGlyZWN0IHVwZGF0ZWQnKTsKICAgIGFyY19yZWRpcmVjdF9saXN0KCRtZXNz
YWdlKTsKICB9Cn0KCi8vIEluc3RhbGxhdGlvbiBmdW5jdGlvbiAtIGJ1aWxkcyBNeVNRTCB0
YWJsZQpmdW5jdGlvbiBhcmNfcmVkaXJlY3RfaW5zdGFsbCgpCnsKCiAgLy8gRm9yIGZpcnN0
IGluc3RhbGwsIGNyZWF0ZSB0YWJsZSBmb3IgdHdlZXRzCiAgJHNxbCA9ICJDUkVBVEUgVEFC
TEUgSUYgTk9UIEVYSVNUUyAiLlBGWC4iYXJjX3JlZGlyZWN0ICI7CiAgJHNxbC49ICIoYXJj
X3JlZGlyZWN0SUQgSU5URUdFUiBBVVRPX0lOQ1JFTUVOVCBQUklNQVJZIEtFWSwKICAgIG9y
aWdpbmFsVXJsIFZBUkNIQVIoMjQwKSwKICAgIHJlZGlyZWN0VXJsIFZBUkNIQVIoMjQwKSk7
IjsKCiAgaWYgKCFzYWZlX3F1ZXJ5KCRzcWwpKSB7CiAgICByZXR1cm4gJ0Vycm9yIC0gdW5h
YmxlIHRvIGNyZWF0ZSBhcmNfcmVkaXJlY3QgdGFibGUnOwogIH0KCn0KCi8vIFVuaW5zdGFs
bCBmdW5jdGlvbiAtIGRlbGV0ZXMgTXlTUUwgdGFibGUgYW5kIHJlbGF0ZWQgcHJlZmVyZW5j
ZXMKCmZ1bmN0aW9uIGFyY19yZWRpcmVjdF91bmluc3RhbGwoKQp7CiAgJHNxbCA9ICJEUk9Q
IFRBQkxFIElGIEVYSVNUUyAiLlBGWC4iYXJjX3JlZGlyZWN0OyI7CiAgaWYgKCFzYWZlX3F1
ZXJ5KCRzcWwpKSB7CiAgICByZXR1cm4gJ0Vycm9yIC0gdW5hYmxlIHRvIGRlbGV0ZSBhcmNf
cmVkaXJlY3QgdGFibGUnOwogIH0KfSI7czozOiJtZDUiO3M6MzI6ImI1YjM4OWYyYTcxMTVj
NTg4ZTkyZDc0Mzg4OGNjNTQ2Ijt9
