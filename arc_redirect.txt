# arc_redirect v0.1-dev
# Love redirects, hate 404s
# Andy Carter
# http://redhotchilliproject.com/

# ......................................................................
# This is a plugin for Textpattern - http://textpattern.com/
# To install: textpattern > admin > plugins
# Paste the following text into the 'Install plugin' box:
# ......................................................................

YToxMTp7czo0OiJuYW1lIjtzOjEyOiJhcmNfcmVkaXJlY3QiO3M6NzoidmVyc2lvbiI7czo3
OiIwLjEtZGV2IjtzOjY6ImF1dGhvciI7czoxMToiQW5keSBDYXJ0ZXIiO3M6MTA6ImF1dGhv
cl91cmkiO3M6MzE6Imh0dHA6Ly9yZWRob3RjaGlsbGlwcm9qZWN0LmNvbS8iO3M6MTE6ImRl
c2NyaXB0aW9uIjtzOjI1OiJMb3ZlIHJlZGlyZWN0cywgaGF0ZSA0MDRzIjtzOjU6Im9yZGVy
IjtzOjE6IjUiO3M6NDoidHlwZSI7czoxOiIxIjtzOjU6ImZsYWdzIjtzOjE6IjIiO3M6NDoi
aGVscCI7czowOiIiO3M6NDoiY29kZSI7czo1NzQ3OiJyZWdpc3Rlcl9jYWxsYmFjaygnYXJj
X3JlZGlyZWN0X2luc3RhbGwnLCdwbHVnaW5fbGlmZWN5Y2xlLmFyY19yZWRpcmVjdCcsICdp
bnN0YWxsZWQnKTsKcmVnaXN0ZXJfY2FsbGJhY2soJ2FyY19yZWRpcmVjdF91bmluc3RhbGwn
LCdwbHVnaW5fbGlmZWN5Y2xlLmFyY19yZWRpcmVjdCcsICdkZWxldGVkJyk7CnJlZ2lzdGVy
X2NhbGxiYWNrKCdhcmNfcmVkaXJlY3QnLCAndHhwX2RpZScsIDQwNCk7CmFkZF9wcml2cygn
YXJjX3JlZGlyZWN0JywgJzEsMiwzLDQnKTsKcmVnaXN0ZXJfdGFiKCdleHRlbnNpb25zJywg
J2FyY19yZWRpcmVjdCcsICdhcmNfcmVkaXJlY3QnKTsKcmVnaXN0ZXJfY2FsbGJhY2soJ2Fy
Y19yZWRpcmVjdF90YWInLCAnYXJjX3JlZGlyZWN0Jyk7CgovKgogKiBDaGVjayBmb3IgcmVk
aXJlY3RlZCBVUkxzIGFuZCBmb3J3YXJkIHdpdGggYSAzMDEgd2hlcmUgbmVjZXNzYXJ5Lgog
Ki8KZnVuY3Rpb24gYXJjX3JlZGlyZWN0KCRldmVudCwgJHN0ZXApIHsKICAkdXJsID0gUFJP
VE9DT0wuJF9TRVJWRVJbJ1NFUlZFUl9OQU1FJ10uJF9TRVJWRVJbJ1JFUVVFU1RfVVJJJ107
CgogIC8vIFN0cmlwIGZpbmFsIHNsYXNoIGZyb20gdXJsCiAgaWYgKHN1YnN0cigkdXJsLC0x
KT09Jy8nKSB7ICR1cmwgPSBzdWJzdHIoJHVybCwgMCwgLTEpOyB9CgogICRzcWwgPSAiU0VM
RUNUIHJlZGlyZWN0VXJsIEZST00gIi5QRlguImFyY19yZWRpcmVjdCBXSEVSRSBvcmlnaW5h
bFVybCA9ICciLiR1cmwuIic7IjsKICAkcnMgPSBzYWZlX3F1ZXJ5KCRzcWwpOyAkcmVkaXJl
Y3QgPSBuZXh0Um93KCRycyk7CgoJICBpZiAoJHJlZGlyZWN0WydyZWRpcmVjdFVybCddKSB7
CgkJICBvYl9lbmRfY2xlYW4oKTsKCgkJICBoZWFkZXIoIlN0YXR1czogMzAxIik7CgkJICBo
ZWFkZXIoIkhUVFAvMS4wIDMwMSBNb3ZlZCBQZXJtYW5lbnRseSIpOwoJCSAgaGVhZGVyKCJM
b2NhdGlvbjogIi4kcmVkaXJlY3RbJ3JlZGlyZWN0VXJsJ10sIFRSVUUsIDMwMSk7CgoJCSAg
Ly8gSW4gY2FzZSB0aGUgaGVhZGVyKCkgbWV0aG9kIGZhaWxzLCBmYWxsIGJhY2sgb24gYSBj
bGFzc2ljIHJlZGlyZWN0CgkJICBlY2hvICc8aHRtbD48aGVhZD48TUVUQSBIVFRQLUVRVUlW
PSJSZWZyZXNoIiBDT05URU5UPSIwO1VSTD0nCgkJICAgIC4kcGVybWxpbmsuJyI+PC9oZWFk
Pjxib2R5PjwvYm9keT48L2h0bWw+JzsKCQkgIGRpZSgpOwoJICB9Cgp9CgpmdW5jdGlvbiBh
cmNfcmVkaXJlY3RfdGFiKCRldmVudCwgJHN0ZXApIHsKICBzd2l0Y2ggKCRzdGVwKSB7CiAg
ICBjYXNlICdhZGQnOiBhcmNfcmVkaXJlY3RfYWRkKCk7IGJyZWFrOwogICAgY2FzZSAnc2F2
ZSc6IGFyY19yZWRpcmVjdF9zYXZlKCk7IGJyZWFrOwogICAgY2FzZSAnZWRpdCc6IGFyY19y
ZWRpcmVjdF9lZGl0KCk7IGJyZWFrOwogICAgZGVmYXVsdDogYXJjX3JlZGlyZWN0X2xpc3Qo
KTsKICB9Cn0KCmZ1bmN0aW9uIGFyY19yZWRpcmVjdF9saXN0KCRtZXNzYWdlID0gJycpIHsK
CiAgcGFnZXRvcCgnYXJjX3JlZGlyZWN0JywkbWVzc2FnZSk7CgogICRzcWwgPSAiU0VMRUNU
ICogRlJPTSAiLlBGWC4iYXJjX3JlZGlyZWN0OyI7CiAgJHJzID0gc2FmZV9xdWVyeSgkc3Fs
KTsKCiAgLy8gSW5jbHVkZSBhIHF1aWNrIGFkZCBmb3JtCiAgJGh0bWwgPSBmb3JtKAogICAg
c3RhcnRUYWJsZSgnZWRpdCcpCiAgICAgIC50cigKICAgICAgICB0ZGEodGFnKCdPcmlnaW5h
bCBVUkwnLCdsYWJlbCcsICcgZm9yPSJvcmlnaW5hbFVybCInKSwnIHN0eWxlPSJ2ZXJ0aWNh
bC1hbGlnbjptaWRkbGUiJykKICAgICAgICAudGQoZklucHV0KCd0ZXh0Jywnb3JpZ2luYWxV
cmwnLCcnLCdlZGl0JywnJywnJywnJywnJywnb3JpZ2luYWxVcmwnKSkKICAgICAgKS50cigK
ICAgICAgICB0ZGEodGFnKCdSZWRpcmVjdCBVUkwnLCdsYWJlbCcsICcgZm9yPSJyZWRpcmVj
dFVybCInKSwnIHN0eWxlPSJ2ZXJ0aWNhbC1hbGlnbjptaWRkbGUiJykKICAgICAgICAudGQo
ZklucHV0KCd0ZXh0JywncmVkaXJlY3RVcmwnLCcnLCdlZGl0JywnJywnJywnJywnJywncmVk
aXJlY3RVcmwnKQogICAgICAgIC5lSW5wdXQoJ2FyY19yZWRpcmVjdCcpCiAgICAgICAgLnNJ
bnB1dCgnYWRkJykuJyZuYnNwOycuZklucHV0KCdzdWJtaXQnLCdhZGQnLGdUeHQoJ0FkZCcp
LCdwdWJsaXNoJykKICAgICAgICApCiAgICAgICkKICAgIC5lbmRUYWJsZSgpCiAgLCAnbWFy
Z2luLWJvdHRvbToyNXB4Jyk7CgogIC8vIEFkZCBhIGxpc3Qgb2YgZXhpc3RpbmcgcmVkaXJl
Y3RzCiAgJGh0bWwgLj0gc3RhcnRUYWJsZSgnbGlzdCcpOwoKICAkaHRtbCAuPSB0cigKICAg
IGhDZWxsICgnSUQjJykKICAgIC5oQ2VsbCAoKQogICAgLmhDZWxsICgnT3JpZ2luYWwgVVJM
JykKICAgIC5oQ2VsbCAoJ1JlZGlyZWN0IFVSTCcpCiAgKTsKCiAgd2hpbGUgKCRyZWRpcmVj
dCA9IG5leHRSb3coJHJzKSkgewogICAgJGVkaXRMaW5rID0gaHJlZihnVHh0KCdlZGl0Jyks
CiAgICAgICc/ZXZlbnQ9YXJjX3JlZGlyZWN0JmFtcDtzdGVwPWVkaXQmYW1wO2lkPScuJHJl
ZGlyZWN0WydhcmNfcmVkaXJlY3RJRCddKTsKICAgICRyZWRpcmVjdExpbmsgPSBocmVmKCdU
ZXN0JywkcmVkaXJlY3RbJ29yaWdpbmFsVXJsJ10pOwogICAgJGh0bWwgLj0gdHIoCiAgICAg
IHRkKCRyZWRpcmVjdFsnYXJjX3JlZGlyZWN0SUQnXSwgMjAsICdpZCcpCiAgICAgIC50ZCgi
PHVsPjxsaSBjbGFzcz0nYWN0aW9uLWVkaXQnPiRlZGl0TGluazwvbGk+PGxpIGNsYXNzPSdh
Y3Rpb24tdmlldyc+JHJlZGlyZWN0TGluazwvbGk+PC91bD4iLCAzNSwgJ2FjdGlvbnMnKQog
ICAgICAudGQoJHJlZGlyZWN0WydvcmlnaW5hbFVybCddLCAxNzUpCiAgICAgIC50ZCgkcmVk
aXJlY3RbJ3JlZGlyZWN0VXJsJ10sIDE3NSkKICAgICk7CiAgfQoKICAkaHRtbCAuPSBlbmRU
YWJsZSgpOwoKICBlY2hvICRodG1sOwoKfQoKZnVuY3Rpb24gYXJjX3JlZGlyZWN0X2VkaXQo
JG1lc3NhZ2U9JycpIHsKICBwYWdldG9wKCdhcmNfcmVkaXJlY3QnLCRtZXNzYWdlKTsKCiAg
JG9yaWdpbmFsVXJsID0gZ3BzKCdvcmlnaW5hbFVybCcpOwogICRyZWRpcmVjdFVybCA9IGdw
cygncmVkaXJlY3RVcmwnKTsKCiAgaWYgKCRpZD1ncHMoJ2lkJykpIHsKICAgICRycyA9IHNh
ZmVfcm93KCdvcmlnaW5hbFVybCxyZWRpcmVjdFVybCcsICdhcmNfcmVkaXJlY3QnLCAiYXJj
X3JlZGlyZWN0SUQgPSAkaWQiKTsKICAgIGV4dHJhY3QoJHJzKTsKICB9CgogIGVjaG8gc3Rh
cnRUYWJsZSgnZWRpdCcpLnRyKHRkKAoKICAgIGZvcm0oCiAgICAgIHRhZyh0YWcoJ09yaWdp
bmFsIFVSTCcsJ2xhYmVsJywgJyBmb3I9Im9yaWdpbmFsVXJsIicpCiAgICAgIC5mSW5wdXQo
J3RleHQnLCdvcmlnaW5hbFVybCcsJG9yaWdpbmFsVXJsLCdlZGl0JywnJywnJywnJywnJywn
b3JpZ2luYWxVcmwnKSwncCcpCiAgICAgIC50YWcodGFnKCdSZWRpcmVjdCBVUkwnLCdsYWJl
bCcsICcgZm9yPSJyZWRpcmVjdFVybCInKQogICAgICAuZklucHV0KCd0ZXh0JywncmVkaXJl
Y3RVcmwnLCRyZWRpcmVjdFVybCwnZWRpdCcsJycsJycsJycsJycsJ3JlZGlyZWN0VXJsJyks
J3AnKQogICAgICAuZUlucHV0KCdhcmNfcmVkaXJlY3QnKQogICAgICAuKCgkaWQpPwogICAg
ICAgIHNJbnB1dCgnc2F2ZScpLmhJbnB1dCgnaWQnLCRpZCkuZklucHV0KCdzdWJtaXQnLCdz
YXZlJyxnVHh0KCdTYXZlJyksJ3B1Ymxpc2gnKQogICAgICAgIDpzSW5wdXQoJ2FkZCcpLmZJ
bnB1dCgnc3VibWl0JywnYWRkJyxnVHh0KCdBZGQnKSwncHVibGlzaCcpCiAgICAgICkuYnIK
ICAgICkKICApKS5lbmRUYWJsZSgpOwoKfQoKZnVuY3Rpb24gYXJjX3JlZGlyZWN0X2FkZCgp
IHsKICAkb3JpZ2luYWxVcmwgPSBncHMoJ29yaWdpbmFsVXJsJyk7CiAgJHJlZGlyZWN0VXJs
ID0gZ3BzKCdyZWRpcmVjdFVybCcpOwoKICBpZiAoJG9yaWdpbmFsVXJsID09PSAnJyB8fCAk
cmVkaXJlY3RVcmwgPT09ICcnKSB7CiAgICBhcmNfcmVkaXJlY3RfZWRpdCgnVW5hYmxlIHRv
IGFkZCBuZXcgcmVkaXJlY3QnKTsKICAgIHJldHVybjsKICB9CgogIC8vIFN0cmlwIGZpbmFs
IHNsYXNoIGZyb20gb3JpZ2luYWwgdXJsCiAgaWYgKHN1YnN0cigkb3JpZ2luYWxVcmwsLTEp
PT0nLycpIHsKICAgICRvcmlnaW5hbFVybCA9IHN1YnN0cigkb3JpZ2luYWxVcmwsIDAsIC0x
KTsKICB9CgogICRxID0gc2FmZV9pbnNlcnQoImFyY19yZWRpcmVjdCIsCiAgICAib3JpZ2lu
YWxVcmwgPSAnIi50cmltKCRvcmlnaW5hbFVybCkuIicsIHJlZGlyZWN0VXJsID0gJyIudHJp
bSgkcmVkaXJlY3RVcmwpLiInIgogICk7CgogICRHTE9CQUxTWydJRCddID0gbXlzcWxfaW5z
ZXJ0X2lkKCk7CgogIGlmICgkcSkgewogICAgJG1lc3NhZ2UgPSBnVHh0KCdSZWRpcmVjdCBh
ZGRlZCcpOwogICAgYXJjX3JlZGlyZWN0X2xpc3QoJG1lc3NhZ2UpOwogIH0KfQoKZnVuY3Rp
b24gYXJjX3JlZGlyZWN0X3NhdmUoKSB7CgogIGlmICghJGlkPWdwcygnaWQnKSkgewogICAg
YXJjX3JlZGlyZWN0X2xpc3QoJ1VuYWJsZSB0byBzYXZlIHJlZGlyZWN0Jyk7CiAgICByZXR1
cm47CiAgfQoKICAkb3JpZ2luYWxVcmwgPSBncHMoJ29yaWdpbmFsVXJsJyk7CiAgJHJlZGly
ZWN0VXJsID0gZ3BzKCdyZWRpcmVjdFVybCcpOwoKICBpZiAoJG9yaWdpbmFsVXJsID09ICcn
IHx8ICRyZWRpcmVjdFVybCA9PSAnJykgewogICAgYXJjX3JlZGlyZWN0X2VkaXQoJ1VuYWJs
ZSB0byBzYXZlIHJlZGlyZWN0Jyk7CiAgICByZXR1cm47CiAgfQoKICAvLyBTdHJpcCBmaW5h
bCBzbGFzaCBmcm9tIG9yaWdpbmFsIHVybAogIGlmIChzdWJzdHIoJG9yaWdpbmFsVXJsLC0x
KT09Jy8nKSB7CiAgICAkb3JpZ2luYWxVcmwgPSBzdWJzdHIoJG9yaWdpbmFsVXJsLCAwLCAt
MSk7CiAgfQoKICAkcnMgPSBzYWZlX3VwZGF0ZSgiYXJjX3JlZGlyZWN0IiwKICAgICJvcmln
aW5hbFVybCAgICA9ICciLnRyaW0oJG9yaWdpbmFsVXJsKS4iJywgIHJlZGlyZWN0VXJsID0g
JyIudHJpbSgkcmVkaXJlY3RVcmwpLiInIiwKICAgICJhcmNfcmVkaXJlY3RJRCA9ICRpZCIK
ICApOwoKICBpZiAoJHJzKSB7CiAgICAkbWVzc2FnZSA9IGdUeHQoJ1JlZGlyZWN0IHVwZGF0
ZWQnKTsKICAgIGFyY19yZWRpcmVjdF9saXN0KCRtZXNzYWdlKTsKICB9Cn0KCi8vIEluc3Rh
bGxhdGlvbiBmdW5jdGlvbiAtIGJ1aWxkcyBNeVNRTCB0YWJsZQpmdW5jdGlvbiBhcmNfcmVk
aXJlY3RfaW5zdGFsbCgpCnsKCiAgLy8gRm9yIGZpcnN0IGluc3RhbGwsIGNyZWF0ZSB0YWJs
ZSBmb3IgdHdlZXRzCiAgJHNxbCA9ICJDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyAiLlBG
WC4iYXJjX3JlZGlyZWN0ICI7CiAgJHNxbC49ICIoYXJjX3JlZGlyZWN0SUQgSU5URUdFUiBB
VVRPX0lOQ1JFTUVOVCBQUklNQVJZIEtFWSwKICAgIG9yaWdpbmFsVXJsIFZBUkNIQVIoMjQw
KSwKICAgIHJlZGlyZWN0VXJsIFZBUkNIQVIoMjQwKSk7IjsKCiAgaWYgKCFzYWZlX3F1ZXJ5
KCRzcWwpKSB7CiAgICByZXR1cm4gJ0Vycm9yIC0gdW5hYmxlIHRvIGNyZWF0ZSBhcmNfcmVk
aXJlY3QgdGFibGUnOwogIH0KCn0KCi8vIFVuaW5zdGFsbCBmdW5jdGlvbiAtIGRlbGV0ZXMg
TXlTUUwgdGFibGUgYW5kIHJlbGF0ZWQgcHJlZmVyZW5jZXMKCmZ1bmN0aW9uIGFyY19yZWRp
cmVjdF91bmluc3RhbGwoKQp7CiAgJHNxbCA9ICJEUk9QIFRBQkxFIElGIEVYSVNUUyAiLlBG
WC4iYXJjX3JlZGlyZWN0OyI7CiAgaWYgKCFzYWZlX3F1ZXJ5KCRzcWwpKSB7CiAgICByZXR1
cm4gJ0Vycm9yIC0gdW5hYmxlIHRvIGRlbGV0ZSBhcmNfcmVkaXJlY3QgdGFibGUnOwogIH0K
fSI7czozOiJtZDUiO3M6MzI6IjFkMTIyNzA4ZjZkYTU2ZGU5OWVmNjk2NGVkZDgzNWRiIjt9
